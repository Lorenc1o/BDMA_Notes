<!DOCTYPE html>
<html>
<head>
  <title>Simple D3 Visualization</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
      .axis path,
      .axis line {
          fill: none;
          stroke: #000;
          shape-rendering: crispEdges;
      }

      .axis text {
          font-family: sans-serif;
          font-size: 10px;
      }

      #selectors-container {
          display: flex;
          justify-content: center;
          margin-top: 20px;
      }

      .selector-box {
          border: 1px solid #ddd;
          background-color: rgb(255, 251, 244);
          padding: 10px;
          margin-right: 20px;
          border-radius: 5px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .selector-box h3 {
          margin-top: 0;
          font-family: Arial, sans-serif;
          color: #333;
          text-align: center;
      }

      input[type="checkbox"] {
          margin-right: 5px;
      }

      label {
          margin-right: 15px;
          font-family: Arial, sans-serif;
      }

      #province-selectors {
          flex-direction: column;
          column-count: 5;
      }

      .nice-button {
          background-color: #ffdd62;
          border: none;
          color: rgb(0, 0, 0);
          padding: 5px 10px;
          text-align: center;
          text-decoration: none;
          display: inline-block;
          font-size: 14px;
          margin: 4px 2px;
          cursor: pointer;
          border-radius: 5px;
      }
  </style>
</head>
<body>
  <svg width="1000" height="400"></svg>  
  <div id="selectors-container">
      <div class="selector-box" id="category-selector-box">
          <h3>Crime Categories</h3>
          <button class="nice-button" id="select-all-categories">Select All</button>
          <button class="nice-button" id="deselect-all-categories">Deselect All</button>
          <div id="category-selectors"></div>
      </div>
      <div class="selector-box" id="province-selector-box">
          <h3>Provinces</h3>
          <button class="nice-button" id="select-all-provinces">Select All</button>
          <button class="nice-button" id="deselect-all-provinces">Deselect All</button>
          <div id="province-selectors"></div>
      </div> 
  </div>



  <script>
    // Select the SVG element and get its width and height
    var width = 800,
    height = 300;

    margin = {
        top: height * 0.1,
        right: width * 0.35,
        bottom: height * 0.1,
        left: width * 0.1
    }

    // Adjust SVG transformation to account for margins
    var svg = d3.select("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    
    // Append a title to the SVG
    svg.append("text")
      .attr("x", width / 2) // Position the title in the middle of the SVG
      .attr("y", -height*0.05) // Position the title 20px from the top of the SVG
      .attr("text-anchor", "middle") // Anchor the text in the middle
      .style("font-size", "20px") // Set the font size
      .style("font-weight", "bold") // Set the font weight
      .text("Total amount of crimes per category in selected provinces."); // Set the title text


    // Define a color scale
    var color = d3.scaleOrdinal(d3.schemeCategory10);

    // Define categories
    var categoriesToInclude = [
        "    1.1.-Homicidios dolosos/asesinatos", 
        "    3.1.-Agresión sexual", 
        "    3.2.-Agresión sexual con penetración", 
        "    5.1.-Hurtos", 
        "    5.2.-Robos con fuerza en las cosas", 
        "    5.3.1.-Robos con violencia en vía pública", 
        "    5.3.2.-Robos con violencia en viviendas", 
        "    5.3.3.-Robos con violencia en establecimientos", 
        "    6.2.-Contra la seguridad vial"];
    
    var categoryTranslations = {
        "    1.1.-Homicidios dolosos/asesinatos": "Intentional Homicides/Assassinations",
        "    3.1.-Agresión sexual": "Sexual Assault",
        "    3.2.-Agresión sexual con penetración": "Sexual Assault with Penetration",
        "    5.1.-Hurtos": "Thefts",
        "    5.2.-Robos con fuerza en las cosas": "Robberies with Force",
        "    5.3.1.-Robos con violencia en vía pública": "Robberies with Violence in Public Spaces",
        "    5.3.2.-Robos con violencia en viviendas": "Robberies with Violence in Houses",
        "    5.3.3.-Robos con violencia en establecimientos": "Robberies with Violence in Establishments",
        "    6.2.-Contra la seguridad vial": "Against Road Safety"
    };


    categoriesToInclude.forEach(category => {
        var checkbox = document.createElement('input');
        checkbox.type = "checkbox";
        checkbox.name = "category";
        checkbox.value = category;
        checkbox.id = category;
        checkbox.checked = true;

        var label = document.createElement('label');
        label.htmlFor = category;
        label.appendChild(document.createTextNode(categoryTranslations[category]));

        var container = document.getElementById('category-selectors');
        container.appendChild(checkbox);
        container.appendChild(label);
        container.appendChild(document.createElement('br'));
    });

    // Load the data
    d3.csv("data.csv").then((data) => {
    // Parse the data
    data.forEach(d => {
        d.Year = d3.timeParse("%Y")(d.Year);
        d.Amount = +d.Amount;
        d.Province = d.Place;
    });

    const provinces = Array.from(new Set(data.map(d => d.Place)));
    console.log("Provinces:", provinces);
    // From provinces, remove: 'Total Nacional', 'En el extranjero', 'Desconocida', 'TOTAL INFRACCIONES PENALES' and 'Notas'
    const provincesToRemove = ['Total Nacional', 'En el extranjero', 'Desconocida', '    TOTAL INFRACCIONES PENALES', 'Notas:'];
    provincesToRemove.forEach(province => {
        const index = provinces.indexOf(province);
        if (index > -1) {
            provinces.splice(index, 1);
        }
    });

    initialProvinces = ['Madrid', 'Barcelona', 'Murcia']

    // Create checkboxes for provinces
    provinces.forEach(province => {
        var checkbox = document.createElement('input');
        checkbox.type = "checkbox";
        checkbox.name = "province";
        checkbox.value = province;
        checkbox.id = province;
        checkbox.checked = initialProvinces.includes(province);

        var label = document.createElement('label');
        label.htmlFor = province;
        label.appendChild(document.createTextNode(province));

        var container = document.getElementById('province-selectors');
        container.appendChild(checkbox);
        container.appendChild(label);
        container.appendChild(document.createElement('br'));
    });

    // Function to process the data
    function processData(data, categoriesToInclude, provincesToInclude){
        var filteredData = data.filter(d => categoriesToInclude.includes(d["Crime Category"]) && provincesToInclude.includes(d.Place));
        var aggregatedData = d3.rollup(filteredData, 
            v => d3.sum(v, d => d.Amount), // Summing up the Amount
            d => d["Crime Category"], 
            d => d.Year.getFullYear() // Grouping by Year
        );

        return aggregatedData;
    }

    // Function to create scales
    function createScales(data) {
      var allYears = Array.from(data.values()).flatMap(map => Array.from(map.keys()));
      // Unique years
      allYears = Array.from(new Set(allYears));
      console.log("All Years Raw:", allYears); // Check the raw year values
      const xScale = d3.scaleLinear().domain(d3.extent(allYears)).range([0, width]);
      const yScale = d3.scaleLinear().domain([0, d3.max(data, ([, yearMap]) => d3.max(yearMap.values()))]).range([height, 0]);

      console.log(xScale.domain(), xScale.range());

      const line = d3.line()
        .x(d => xScale(d.year))
        .y(d => yScale(d.amount));

      const xAxis = d3.axisBottom(xScale); // Format ticks to show years
      const yAxis = d3.axisLeft(yScale);

      return {xScale, yScale, xAxis, yAxis, line};
    }

    // Function to draw axes
    function drawAxes(xAxis, yAxis) {
      svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

      svg.append("g")
        .call(yAxis);
    }

    // Function to create lines for each category
    function drawCategoryLines(aggregatedData, line) {
      aggregatedData.forEach((yearMap, category) => {
        const dataArray = Array.from(yearMap, ([year, amount]) => ({ year: new Date(year), amount }));
        
        svg.append("path")
          .datum(dataArray)
          .attr("fill", "none")
          .attr("stroke", color(category))
          .attr("stroke-width", 2)
          .attr("d", line);
      });
    }

    // Function to draw the legend
    function drawLegend(selectedCategories) {
      var legend = svg.selectAll(".legend")
        .data(color.domain().filter(d => selectedCategories.includes(d)))
        .enter().append("g")
        .attr("class", "legend")
        .attr("transform", (d, i) => "translate(0," + i * 20 + ")");

      legend.append("rect")
        .attr("x", width + 20)
        .attr("width", 18)
        .attr("height", 18)
        .style("fill", color);

      legend.append("text")
        .attr("x", width + 40)
        .attr("y", 9)
        .attr("dy", ".35em")
        .style("text-anchor", "start")
        .style("font-size", "14px")
        .text(d => categoryTranslations[d]);
    }

    // Function to update the chart
    function updateChart() {
      var selectedCategories = d3.selectAll("input[name='category']:checked").nodes()
        .map(d => d.value);

      var selectedProvinces = d3.selectAll("input[name='province']:checked").nodes()

      // Filter the aggregated data based on selected categories
      var filteredData = processData(data, selectedCategories, selectedProvinces.map(d => d.value));

      // Clear the existing elements
      svg.selectAll("path").remove();
      svg.selectAll(".legend").remove();
      svg.selectAll("g").remove();

      // Redraw lines and legend
      const {xScale, yScale, xAxis, yAxis, line} = createScales(filteredData);
      drawAxes(xAxis, yAxis);
      drawCategoryLines(new Map(filteredData), line);
      drawLegend(selectedCategories);
    }

    updateChart();

    // TODO: Add code to create dropdown menus or checkboxes and update the chart when the selection changes  
    d3.selectAll("input[name='category']").on("change", updateChart);
    d3.selectAll("input[name='category'], input[name='province']").on("change", updateChart);

    document.getElementById("select-all-categories").addEventListener("click", function() {
        document.querySelectorAll("#category-selectors input[type='checkbox']").forEach(function(checkbox) {
            checkbox.checked = true;
        });
        updateChart();
    });

    document.getElementById("deselect-all-categories").addEventListener("click", function() {
        document.querySelectorAll("#category-selectors input[type='checkbox']").forEach(function(checkbox) {
            checkbox.checked = false;
        });
        updateChart();
    });

    document.getElementById("select-all-provinces").addEventListener("click", function() {
        document.querySelectorAll("#province-selectors input[type='checkbox']").forEach(function(checkbox) {
            checkbox.checked = true;
        });
        updateChart();
    });

    document.getElementById("deselect-all-provinces").addEventListener("click", function() {
        document.querySelectorAll("#province-selectors input[type='checkbox']").forEach(function(checkbox) {
            checkbox.checked = false;
        });
        updateChart();
    });

  });

  </script>
</body>
</html>
